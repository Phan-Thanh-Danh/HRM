@{
    ViewData["Title"] = "Đăng ký khuôn mặt 3D";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            @if (ViewBag.IsRegistered == true)
            {
                <h3 class="mb-3"><i class="fas fa-user-edit me-2 text-primary"></i>Cập nhật khuôn mặt 3D</h3>
                <p id="instruction-text" class="text-secondary font-weight-bold">Chuẩn bị thực hiện quy trình xác thực người
                    thật.</p>
                }
            else
                {
                    <h3 class="mb-3"><i class="fas fa-user-shield me-2 text-primary"></i>Đăng ký khuôn mặt 3D</h3>
                    <p id="instruction-text" class="text-secondary font-weight-bold">Hệ thống yêu cầu xác thực người thật qua cử
                        động.</p>
                    }

                    <div class="position-relative d-inline-block mt-3 shadow-lg"
                         style="border-radius: 20px; overflow: hidden; border: 4px solid #28a745;">
                        <video id="video" width="640" height="480" autoplay muted
                               style="background: #000; display: block;"></video>
                        <canvas id="overlay" width="640" height="480" class="position-absolute"
                                style="top: 0; left: 0;"></canvas>
                    </div>

                    <div id="status-message" class="alert alert-info mt-4 py-3 shadow-sm">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        Đang khởi tạo camera và mô hình AI...
                    </div>

                    <div class="mt-4">
                        <button id="btn-register" class="btn btn-primary btn-lg px-5 shadow" disabled>
                            <i class="fas fa-camera me-2"></i>Bắt đầu lấy mẫu
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary btn-lg ms-2">Bỏ qua</a>
                    </div>
                </div>
            </div>
        </div>

        @section Scripts {
            <script src="https://cdn.jsdelivr.net/npm/@@mediapipe/face_mesh/face_mesh.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/@@mediapipe/drawing_utils/drawing_utils.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
            <script src="~/js/attendance-face.js"></script>

            <script>
                $(document).ready(async function () {
                const video = document.getElementById('video');
                const overlay = document.getElementById('overlay');
                const statusMsg = document.getElementById('status-message');
                const instructionText = document.getElementById('instruction-text');
                const btnRegister = document.getElementById('btn-register');

                try {
                await faceAttendance.init('video', 'overlay');
                faceAttendance.startVideo();

                statusMsg.className = "alert alert-success mt-4 py-3 shadow-sm";
                statusMsg.innerText = "Hệ thống 3D đã sẵn sàng!";
                instructionText.innerHTML = "Nhấn nút và <b>giữ mặt bình thường</b> để bắt đầu.";
                btnRegister.disabled = false;

                setupMediaPipe();
                } catch (err) {
                statusMsg.className = "alert alert-danger mt-4 py-3";
                statusMsg.innerText = "Lỗi khởi tạo: " + err.message;
                }

                function setupMediaPipe() {
                faceAttendance.faceMesh.onResults(onResults);
                let registrationActive = false;

                btnRegister.onclick = () => {
                registrationActive = true;
                btnRegister.disabled = true;
                faceAttendance.resetLiveness();
                statusMsg.className = "alert alert-info mt-4 py-3 shadow-sm";
                statusMsg.innerHTML = "<div class='spinner-border spinner-border-sm me-2'></div> Đang chờ bạn giữ mặt bình thường...";
                };

                function onResults(results) {
                if (faceAttendance.isPaused) return;

                if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
                faceAttendance.ctx.clearRect(0, 0, overlay.width, overlay.height);
                if (registrationActive) {
                faceAttendance.resetLiveness();
                statusMsg.innerText = "Hãy đưa mặt vào trước camera.";
                }
                return;
                }

                const landmarks = results.multiFaceLandmarks[0];
                faceAttendance.ctx.clearRect(0, 0, overlay.width, overlay.height);

                drawConnectors(faceAttendance.ctx, landmarks, FACEMESH_TESSELATION, { color: '#28a74540', lineWidth: 1 });
                drawConnectors(faceAttendance.ctx, landmarks, FACEMESH_LIPS, { color: '#1e7e34' });

                if (registrationActive) {
                const liveness = faceAttendance.updateLiveness(landmarks, results.multiFaceLandmarks);

                if (liveness.state === 'VERIFIED') {
                registrationActive = false;
                faceAttendance.pauseProcessing(true);
                statusMsg.className = "alert alert-success mt-4 py-3 shadow";
                statusMsg.innerText = "Xác nhận thực thể 3D thành công! Đang lưu mẫu...";
                captureAndSave();
                } else if (liveness.state === 'SPOOF') {
                statusMsg.className = "alert alert-danger mt-4 py-3 shadow";
                statusMsg.innerText = "CẢNH BÁO: " + liveness.msg;
                btnRegister.disabled = false; // Allow retry
                registrationActive = false;
                } else {
                statusMsg.className = "alert alert-warning mt-4 py-3 shadow-sm";
                statusMsg.innerText = liveness.msg;
                }
                }
                }

                async function captureAndSave() {
                const descriptor = await faceAttendance.captureDescriptor();
                if (descriptor) {
                saveDescriptor(descriptor);
                } else {
                statusMsg.className = "alert alert-danger mt-4 py-3 shadow";
                statusMsg.innerText = "Lỗi: Không thể trích xuất đặc điểm. Hãy thử lại.";
                btnRegister.disabled = false;
                faceAttendance.pauseProcessing(false);
                faceAttendance.resetLiveness();
                }
                }

                async function mpLoop() {
                if (!video.paused && !video.ended && !faceAttendance.isPaused) {
                await faceAttendance.faceMesh.send({ image: video });
                }
                requestAnimationFrame(mpLoop);
                }
                mpLoop();
                }

                async function saveDescriptor(descriptor) {
                try {
                const response = await fetch('/Attendance/SaveFaceDescriptor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(descriptor)
                });

                if (response.ok) {
                statusMsg.className = "alert alert-success mt-4 py-3 shadow";
                statusMsg.innerText = "Đăng ký thành công! Đang chuyển hướng...";
                setTimeout(() => window.location.href = '/Attendance/Index', 1500);
                } else {
                throw new Error(await response.text());
                }
                } catch (err) {
                statusMsg.className = "alert alert-danger mt-4 py-3 shadow";
                statusMsg.innerText = "Lỗi hệ thống: " + err.message;
                btnRegister.disabled = false;
                faceAttendance.pauseProcessing(false);
                faceAttendance.resetLiveness();
                }
                }
                });
            </script>
        }